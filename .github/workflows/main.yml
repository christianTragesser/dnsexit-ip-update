name: Test

on:
  push:
    branches: [ "master", "golang-client" ]

  workflow_dispatch:

jobs:
  lint:
    runs-on: ubuntu-latest
    container: golangci/golangci-lint
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run linter
        run: golangci-lint run

  unit-test:
    runs-on: ubuntu-latest
    container: golang:stretch 
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Run unit tests
        run: go test -v --cover ./dnsexit
  
  publish:
    needs: unit-test
    runs-on: ubuntu-latest
    container: registry.gitlab.com/christiantragesser/gitlab-ci-templates/intermodal:latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1

      - name: build 
        run: goreleaser build --snapshot

    #- name: Configure docker client 
    #  run: |
    #    mkdir -p /kaniko/.docker && \
    #    cat << EOF > /kaniko/.docker/config.json
    #    {
    #      "auths": {
    #        "registry.gitlab.com": {
    #          "auth": "$(echo -n ${{ secrets.GITLAB_REGISTRY_USER }}:${{ secrets.GITLAB_REGISTRY_PAT }} | base64)"
    #        }
    #      }
    #    }
    #    EOF

    #- name: Publish container image 
    #  run: |
    #    /kaniko/executor
    #    --context .
    #    --dockerfile ./pkg/Dockerfile
    #    --destination registry.gitlab.com/christiantragesser/dnsexit-ip-update:golang-client
    #    --skip-unused-stages
    #    --target publish